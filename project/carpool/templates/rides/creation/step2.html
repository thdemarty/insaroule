{% extends 'base.html' %}
{% load i18n static %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'vendors/leaflet/leaflet.css' %}"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
{% endblock extrahead %}

{% block content %}
<div class="container mt-3">
    <form action="" method="post">
        {% csrf_token %}
        <h1>Publication d'un trajet</h1>
        {% include 'rides/creation/progress.html' with value=50 %}
        <div class="row">
            <div class="col-lg-8 order-lg-1 order-2" style="height: 65vh;">
                <!-- Make map fill the rest of the col-lg-8 -->
                <div id="map" style="width: 100%; height: 100%;">
                </div>
            </div>
            <div class="col-lg-4 order-lg-2 order-1">
                <div class="card mb-3">
                    <div class="card-body">Publication en cours d'un trajet de
                        <b>{{ step1_data.d_city }}</b> to <b>{{ step1_data.a_city }}</b> 
                        (le <b>{{ departure_datetime }}</b>)
                    </div>
                </div>
                
                <!-- Other fields -->
                <div class="mb-3">
                    <label for="{{ form.seats.id_for_label }}">{% translate "Seats offering" %}</label>
                    {{ form.seats_offered }}
                    {% if form.seats_offered.errors %}
                    <span class="text-danger">{{ form.seats_offered.errors }}</span>
                    {% endif %}
                </div>

                <div class="mb-2">
                    <label for="{{ form.price.id_for_label }}">
                        {% translate "Price and Payment method" %}
                    </label>
                    {{ form.price }}

                    <div class="mt-1 small text-center">
                        {% for payment_method in payment_methods %}
                        <div class="form-check form-check-inline" id="payment-options">
                            <input class="form-check-input" type="checkbox" id="id_{{ payment_method.0 }}"
                                value="{{ payment_method.0 }}" name="payment_method">
                            <label class="form-check-label" for="id_{{ payment_method.0 }}">
                                {{ payment_method.1 }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>



                <div class="mb-3">
                    <label for="vehicle" class="d-flex justify-content-between vertical-align mb-1">
                        <span class="mt-auto">{% translate "Vehicle" %}</span>
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal"
                            data-bs-target="#vehicleModal" id="createButton">
                            {% translate "Add a new vehicle"%}
                        </button>
                    </label>
                    {% if user.vehicles.all %}
                    <div class="input-group">
                        <select class="form-select" name="vehicle" id="vehicle">
                            {% for vehicle in user.vehicles.all %}
                            <option value="{{ vehicle.pk }}" data-name="{{ vehicle.name }}"
                                data-description="{{ vehicle.description }}" data-seats="{{ vehicle.seats }}"
                                data-co2="{{ vehicle.geqCO2_per_km}}">
                                {{ vehicle.name }} -
                                {% blocktranslate trimmed count vehicle.seats as seat_count %}
                                {{ seat_count }} seat
                                {% plural %}
                                {{ seat_count }} seats
                                {% endblocktranslate %}
                            </option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary" type="button" id="editVehicleBtn">
                            {% translate "Edit" %}
                        </button>
                    </div>
                    {% else %}
                    <div class="card border border-primary" style="border-style: dashed !important;" id="NoVehicleCard">
                        <div class="card-body">
                            {% blocktranslate trimmed %}
                            You don't have any vehicle registered to your account. Please add one to
                            publish a ride.
                            {% endblocktranslate %}
                        </div>
                    </div>

                    {% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.comment.id_for_label }}">
                        {% translate "Comment (optional)" %}
                    </label>
                    {{ form.comment }}
                    {% if form.comment.errors %}
                    <span class="text-danger">{{ form.comment.errors }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <a href="{% url 'carpool:list' %}" class="btn btn-secondary w-100">
                    {% translate "Cancel" %}
                </a>
            </div>
            <div class="col">
                <button class="btn btn-primary w-100" type="submit">
                    {% translate "Publish ride" %}
                </button>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="vehicleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="vehicleForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="vehicleModalTitle">Vehicle form</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="vehicle_id" id="vehicle_id">

                    <div class="mb-3">
                        <label for="vehicle_name">{% translate "Name" %}<sup class="text-danger">*</sup></label>
                        <input type="text" name="name" id="vehicle_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="vehicle_description">{% translate "Visual Description" %}<sup
                                class="text-danger">*</sup></label>
                        <input type="text" name="description" id="vehicle_description" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="vehicle_seats">{% translate "Maximum number of seats" %}<sup
                                    class="text-danger">*</sup></label>
                            <input type="text" name="seats" id="vehicle_seats" class="form-control">
                        </div>
                        <div class="col mt-auto">
                            <label for="vehicle_co2">{% translate "CO<sub>2</sub> emission (g/km)" %}</label>
                            <input type="text" name="geqCO2_per_km" id="vehicle_co2" class="form-control">
                        </div>
                    </div>
                    <p class="small text-muted">
                        {% blocktranslate trimmed %}
                        You can find the CO<sub>2</sub> emission on your vehicle registration certificate
                        (in France, it's in the section V.7).
                        {% endblocktranslate %}
                    </p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% translate "Close" %}
                    </button>
                    <button type="submit" class="btn btn-primary">{% translate "Save changes" %}</button>
                </div>
        </form>
    </div>
</div>

{% endblock content %}

{% block extrascript %}
{{ step1_data|json_script:"step1_data" }}



<script src="{% static 'vendors/leaflet/leaflet.js' %}" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
<script>
    var map = L.map("map", {
        doubleClickZoom: false,
        boxZoom: false,
        dragging: false,
        doubleClickZoom: false,
        scrollWheelZoom: false,
        zoomControl: false,
    }).setView([46.2321929, 2.209666999999996], 6.4);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);
</script>



<script>
    // =================================================================
    // Initial map setup
    // =================================================================
    var departureM, arrivalM, route = null;


    const step1_data = JSON.parse(
        document.getElementById("step1_data").textContent,
    );

    console.debug("Step 1 data:", step1_data);


    function updateMap() {
        // Ensure both markers are defined before calculating bounds
        // and add a padding to the bounds

        var bounds = L.latLngBounds(
            departureM ? departureM.getLatLng() : [48.120799, -1.635791],
            arrivalM ? arrivalM.getLatLng() : [48.120799, -1.635791],
        );

        map.fitBounds(bounds, (padding = [50, 50]));
    }



    document.addEventListener("DOMContentLoaded", function () {
        if (
            step1_data.d_latitude &&
            step1_data.d_longitude &&
            departureM === undefined
        ) {
            // If departure coordinates are set, create the marker
            const lat = step1_data.d_latitude;
            const lng = step1_data.d_longitude;
            departureM = L.marker([lat, lng]).addTo(map);
            updateMap();
        }
        // FIXME: if hArrivalLatitude and hArrivalLongitude are undefined
        if (
            step1_data.a_latitude &&
            step1_data.a_longitude &&
            arrivalM === undefined
        ) {
            // If arrival coordinates are set, create the marker
            const lat = step1_data.a_latitude;
            const lng = step1_data.a_longitude;
            arrivalM = L.marker([lat, lng]).addTo(map);
            updateMap();
        }

        if (step1_data.r_geometry) {
            // If route is set, display it on the map
            const routeData = JSON.parse(step1_data.r_geometry);
            route = L.geoJSON(routeData, {
                style: {
                    color: "#3388ff",
                    weight: 5,
                    opacity: 0.7,
                },
            }).addTo(map);
            map.fitBounds(route.getBounds(), { padding: [50, 50] });
        }
        
        // TODO: fix this stuff
        // Update value of Choices when already set in hidden inputs
        // if (hDepartureFullText.value) {
        //     departure.setValue([
        //         `${hDepartureLatitude.value}/${hDepartureLongitude.value}`,
        //         hDepartureFullText.value,
        //     ]);
        // }

        // if (hArrivalFullText.value) {
        //     arrival.setValue([
        //         `${hArrivalLatitude.value}/${hArrivalLongitude.value}`,
        //         hArrivalFullText.value,
        //     ]);
        // }
    });
    // =================================================================
    // Automated enabling/disabling of payment method checkboxes
    // =================================================================
    document.addEventListener("DOMContentLoaded", function () {
        const priceInput = document.getElementById("id_price_per_seat");
        const paymentCheckboxes = document.querySelectorAll(
            '#payment-options input[type="checkbox"]',
        );

        function togglePaymentMethodCheckboxes() {
            const price = parseFloat(priceInput.value) || 0;
            const disable = price === 0;

            paymentCheckboxes.forEach((checkbox) => {
                checkbox.disabled = disable;
            });
        }

        togglePaymentMethodCheckboxes();

        priceInput.addEventListener("input", togglePaymentMethodCheckboxes);
    });
</script>

<script>
    function createToast(alert, content) {
        const toastContainer = document.getElementById("toastContainer");
        const toastEl = document.createElement("div");

        if (alert == "debug") {
            toastEl.className = "toast align-items-center bg-secondary text-white";
        } else if (alert == "info") {
            toastEl.className = "toast align-items-center bg-info text-white";
        } else if (alert == "success") {
            toastEl.className = "toast align-items-center bg-success text-white";
        } else if (alert == "warning") {
            toastEl.className = "toast align-items-center bg-warning";
        } else if (alert == "error") {
            toastEl.className = "toast align-items-center bg-danger text-white";
        } else {
            toastEl.className = "toast align-items-center bg-secondary text-white";
        }

        toastEl.setAttribute("role", "alert");
        toastEl.setAttribute("aria-live", "assertive");
        toastEl.setAttribute("aria-atomic", "true");

        const toastContent = document.createElement("div");
        toastContent.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${content}
                </div>
                <button type="button" class="btn-close me-2 m-auto ${alert == "debug" || alert == "info" || alert == "success" || alert == "error"
                ? "btn-close-white"
                : ""
            }" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        toastEl.appendChild(toastContent);
        toastContainer.appendChild(toastEl);

        bootstrap.Toast.getOrCreateInstance(toastEl).show();
    }


    // =================================================================
    // Vehicle modal form handling
    // =================================================================
    function vehicleEditBtnEventListener() {
        let vehicleSelect = document.getElementById("vehicle");
        let vehicleModal = bootstrap.Modal.getInstance(
            document.getElementById("vehicleModal"),
        );
        let vehicleModalTitle = document.getElementById("vehicleModalTitle");
        const vehicleIdInput = document.getElementById("vehicle_id");
        const vehicleNameInput = document.getElementById("vehicle_name");
        const vehicleDescriptionInput = document.getElementById(
            "vehicle_description",
        );
        const vehicleSeatsInput = document.getElementById("vehicle_seats");
        const vehicleCO2Input = document.getElementById("vehicle_co2");
        const selectedOption =
            vehicleSelect.options[vehicleSelect.selectedIndex];

        if (!selectedOption) {
            alert("{% translate 'Please select a vehicle to edit.' %}");
            return;
        }

        vehicleModalTitle.textContent = "{% translate 'Edit vehicle' %}";
        vehicleIdInput.value = selectedOption.value;
        vehicleNameInput.value = selectedOption.dataset.name || "";
        vehicleDescriptionInput.value =
            selectedOption.dataset.description || "";
        vehicleSeatsInput.value = selectedOption.dataset.seats || "";
        vehicleCO2Input.value = selectedOption.dataset.co2 || "";

        vehicleModal.show();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const vehicleModal = new bootstrap.Modal(
            document.getElementById("vehicleModal"),
        );
        const vehicleForm = document.getElementById("vehicleForm");
        const vehicleModalTitle = document.getElementById("vehicleModalTitle");
        const createButton = document.getElementById("createButton");
        const editVehicleBtn = document.getElementById("editVehicleBtn");

        const vehicleIdInput = document.getElementById("vehicle_id");
        const vehicleNameInput = document.getElementById("vehicle_name");
        const vehicleDescriptionInput = document.getElementById(
            "vehicle_description",
        );
        const vehicleSeatsInput = document.getElementById("vehicle_seats");
        const vehicleCO2Input = document.getElementById("vehicle_co2");

        // Open modal in "create" mode
        createButton.addEventListener("click", function () {
            vehicleModalTitle.textContent = "{% translate 'Add a new vehicle' %}";
            vehicleForm.reset();
            vehicleIdInput.value = "";
        });

        // Open modal in "edit" mode
        if (editVehicleBtn) {
            editVehicleBtn.addEventListener("click", vehicleEditBtnEventListener);
        }

        vehicleForm.addEventListener("submit", function (event) {
            event.preventDefault();

            // Nettoyer les anciennes erreurs
            vehicleForm.querySelectorAll(".is-invalid").forEach((el) => {
                el.classList.remove("is-invalid");
            });
            vehicleForm.querySelectorAll(".invalid-feedback").forEach((el) => el.remove());

            const formData = new FormData(vehicleForm);
            const url = formData.get("vehicle_id")
                ? `/api/vehicles/${formData.get("vehicle_id")}/update/`
                : "/api/vehicles/new/";

            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                },
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((data) => {
                            if (data.errors) {
                                for (const [field, messages] of Object.entries(data.errors)) {
                                    const input = vehicleForm.querySelector(`[name="${field}"]`);
                                    if (input) {
                                        input.classList.add("is-invalid");

                                        const feedback = document.createElement("div");
                                        feedback.classList.add("invalid-feedback");
                                        feedback.textContent = messages.join(" ");
                                        input.insertAdjacentElement("afterend", feedback);
                                    }
                                }
                            }

                            if (data.error) {
                                createToast("error", data.error);
                            }

                            throw new Error("Validation error");
                        });
                    }
                    return response.json();
                })
                .then((data) => {
                    console.debug("Vehicle saved:", data);
                    createToast("success", "{% translate 'Vehicle saved successfully!' %}");
                    vehicleModal.hide();

                    // Update the vehicle select dropdown
                    let vehicleSelect = document.getElementById("vehicle");

                    if (!vehicleSelect) {
                        console.debug("Creating vehicle select");
                        // If the select doesn't exist, create it
                        // with the edit button next to it (in an input group)
                        const inputGroup = document.createElement("div");
                        inputGroup.className = "input-group";
                        inputGroup.id = "vehicleInputGroup";


                        vehicleSelect = document.createElement("select");
                        vehicleSelect.id = "vehicle";
                        vehicleSelect.name = "vehicle";
                        vehicleSelect.className = "form-select";

                        const editButton = document.createElement("button");
                        editButton.className = "btn btn-secondary";
                        editButton.type = "button";
                        editButton.id = "editVehicleBtn";
                        editButton.textContent = "{% translate 'Edit' %}";
                        editButton.addEventListener("click", vehicleEditBtnEventListener);

                        inputGroup.appendChild(vehicleSelect);
                        inputGroup.appendChild(editButton);

                        // Replace NoVehicleCard with the select
                        const noVehicleCard = document.getElementById("NoVehicleCard");
                        if (noVehicleCard) {
                            noVehicleCard.replaceWith(inputGroup);
                        }

                    }
                    let option = vehicleSelect.querySelector(`option[value="${data.vehicle.id}"]`);
                    if (option) {
                        console.debug("Updating existing vehicle option");
                        // Update existing option
                        option.textContent = `${data.vehicle.name} - ${data.vehicle.seats} {% translate "seat" %}${data.vehicle.seats > 1 ? 's' : ''}`;
                        option.dataset.name = data.vehicle.name;
                        option.dataset.description = data.vehicle.description;
                        option.dataset.seats = data.vehicle.seats;
                        option.dataset.co2 = data.vehicle.geqCO2_per_km;
                    } else {
                        console.debug("Adding new vehicle option");
                        // Add new option
                        option = document.createElement("option");
                        option.value = data.vehicle.id;
                        option.textContent = `${data.vehicle.name} - ${data.vehicle.seats} {% translate "seat" %}${data.vehicle.seats > 1 ? 's' : ''}`;
                        option.dataset.name = data.vehicle.name;
                        option.dataset.description = data.vehicle.description;
                        option.dataset.seats = data.vehicle.seats;
                        option.dataset.co2 = data.vehicle.geqCO2_per_km;
                        vehicleSelect.appendChild(option);
                    }
                    vehicleSelect.value = data.vehicle.id;
                })
                .catch((error) => {
                    console.error(error);
                });
        });

    });

</script>
{% endblock extrascript %}